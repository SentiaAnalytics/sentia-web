machine:
  services:
    - docker
  ruby:
    version: rbx-2.2.6
  node:
    version: 0.10.22

  environment:
    TEST_MODE: ff
    PATH: /home/ubuntu/web/google-cloud-sdk/bin:$PATH

dependencies:
  pre:
    - wget https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.zip && unzip google-cloud-sdk.zip && rm google-cloud-sdk.zip
    - sudo google-cloud-sdk/install.sh --usage-reporting=true --path-update=true --bash-completion=true --rc-path=/.bashrc --disable-installation-options
    - sudo google-cloud-sdk/bin/gcloud --quiet components update preview alpha beta app
  override:
    - npm install

test:
  pre:
    -  echo $TEST_MODE
  override:
    - echo $PATH
    - sudo chmod a+x google-cloud-sdk/bin/gcloud && gcloud --help
    - npm test
    - docker build -t gcr.io/sentia_analytics/web:$CIRCLE_BUILD_NUM .
    - sh ci/runDocker.sh && sleep 5
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000
    - cd cucumber && bundle install && bundle exec cucumber
