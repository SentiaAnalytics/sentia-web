machine:
  services:
    - docker
  ruby:
    version: rbx-2.2.6
  node:
    version: 4.0.0
  python:
    version: pypy-2.2.1

  environment:
    SENTIA_PROJECT: sentia-analytics
    SENTIA_ZONE: europe-west1-b
    SENTIA_CLUSTER: sentia-web
    TEST_MODE: ff
    CLOUDSDK_PYTHON_SITEPACKAGES: 1

dependencies:
  cache_directories:
    - "~/docker"
  pre:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  override:
    - npm install
    - npm run build-prod
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -t sentia/web:latest .
    - mkdir -p ~/docker; docker save sentia/web:latest > ~/docker/image.tar
    - bundle install:
        timeout: 240

test:
  override:
    - npm test
    - docker tag sentia/web:latest sentia/web:$CIRCLE_BUILD_NUM
    - docker push sentia/web:latest
    - docker push sentia/web:$CIRCLE_BUILD_NUM
    - curl -X POST $DEPLOY_TRIGGER_TESTING
    - ./ci/wait-for-redeploy
    - npm run cucumber

deployment:
  production:
    branch: production
    commands:
      - curl -X POST $DEPLOY_TRIGGER_PRODUCTION
